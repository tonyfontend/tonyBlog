/* fromone 2015-04-02  by yansm*/
var USERSTATUS={islogin:!1},APP_ID="cyrCA2YHb",APP_KEY="5c81636378414a40b658c06b10d10f34",REDIRECT_URL="http://yansm.github.io/fromone/checkOAUTH.html",TOKEN="",REACT_COMMENT={},COMMENT_URL_TOKEN="https://changyan.sohu.com/api/oauth2/token",COMMENT_URL_USER="http://changyan.sohu.com/api/2/user/info",COMMENT_URL_LIST="http://changyan.sohu.com/api/2/topic/load",COMMENT_URL_LOGOUT="http://changyan.sohu.com/api/2/logout",COMMENT_URL_COMMENTS="http://changyan.sohu.com/api/2/topic/comments",COMMENT_URL_ADD="http://changyan.sohu.com/api/2/comment/submit",COMMENT_URL_LOGIN="https://changyan.sohu.com/api/oauth2/authorize?client_id=cyrCA2YHb&redirect_uri=http://yansm.github.io/fromone/checkOAUTH.html&response_type=code",MONTHS=["Jan.","Feb.","Mar.","Apr.","May.","Jun.","Jul.","Aug.","Sept.","Oct.","Nov.","Dec."];Date.prototype.format=function(a){var b={"M+":this.getMonth()+1,"d+":this.getDate(),"h+":this.getHours(),"m+":this.getMinutes(),"s+":this.getSeconds(),"q+":Math.floor((this.getMonth()+3)/3),S:this.getMilliseconds()};/(y+)/.test(a)&&(a=a.replace(RegExp.$1,(this.getFullYear()+"").substr(4-RegExp.$1.length)));for(var c in b)new RegExp("("+c+")").test(a)&&(a=a.replace(RegExp.$1,1==RegExp.$1.length?b[c]:("00"+b[c]).substr((""+b[c]).length)));return a},$.extend({getUrlVars:function(){for(var a,b=[],c=window.location.href.slice(window.location.href.indexOf("?")+1).split("&"),d=0;d<c.length;d++)a=c[d].split("="),b.push(a[0]),b[a[0]]=a[1];return b},getUrlVar:function(a){return $.getUrlVars()[a]},getRootPath:function(){var a=window.document.location.href,b=window.document.location.pathname,c=a.indexOf(b),d=a.substring(0,c),e=b.substring(0,b.substr(1).indexOf("/")+1);return d+e},cookie:function(a,b,c){if(arguments.length>1&&(null===b||"object"!=typeof b)){if(c=jQuery.extend({},c),null===b&&(c.expires=-1),"number"==typeof c.expires){var d=c.expires,e=c.expires=new Date;e.setTime(e.getTime()+1e3*d)}return document.cookie=[encodeURIComponent(a),"=",c.raw?String(b):encodeURIComponent(String(b)),c.expires?"; expires="+c.expires.toUTCString():"",c.path?"; path="+c.path:"",c.domain?"; domain="+c.domain:"",c.secure?"; secure":""].join("")}c=b||{};var f,g=c.raw?function(a){return a}:decodeURIComponent;return(f=new RegExp("(?:^|; )"+encodeURIComponent(a)+"=([^;]*)").exec(document.cookie))?g(f[1]):null},setUrlWidthVars:function(a,b){var c=b+"/"+a.url+".html";return c},loadImg:function(b,c,d,e){function f(a,f){var i=new Image;i.onload=function(){g++,c&&c(g,b.length,a,f),d&&g==b.length&&d(h)},i.onerror=function(){g++,h++,e&&e(g,b.length,a,f)},i.src=a}var g=0,h=0,i="[object Object]"===Object.prototype.toString.call(b)?!0:!1,b=i?b.get():b;for(a in b){var j=i?$(b[a]).attr("data-src"):b[a];f(j,b[a])}},getRndNum:function(a){for(var b=[],c=0;a>c;c++)b.push(Math.floor(4*Math.random()+1));return b},getToken:function(){var a=$.getUrlVar("code");$.ajax({data:{code:a,client_id:APP_ID,client_secret:APP_KEY,grant_type:"authorization_code",redirect_uri:REDIRECT_URL},url:COMMENT_URL_TOKEN,type:"post",success:function(a){parent.$.setToken(a)},erroe:function(a){console.debug(a)}})},setToken:function(a){$.cookie("fromone_token",a.access_token,{expires:a.expires_in,path:"/"}),$.setUser(),$.closeModal()},setUser:function(){var a=$.cookie("fromone_token"),b="theComment";a||REACT_COMMENT[b]&&REACT_COMMENT[b].takeUser&&REACT_COMMENT[b].takeUser(null,{}),$.ajax({data:{access_token:a,client_id:APP_ID},sync:!1,url:COMMENT_URL_USER,type:"get",dataType:"JSONP",success:function(c){REACT_COMMENT[b]&&REACT_COMMENT[b].takeUser&&REACT_COMMENT[b].takeUser(a,c)},error:function(a){console.debug(a),$.cookie("fromone_token","",{expires:-1}),REACT_COMMENT[b]&&REACT_COMMENT[b].takeUser&&REACT_COMMENT[b].takeUser(null,{})}})},openModal:function(a){$(".modal-area").eq(0).find(".modal-box").html(a).end().show(function(){$(this).addClass("current")})},closeModal:function(){$(".modal-area").eq(0).find(".modal-box").html("").end().removeClass("current"),setTimeout(function(){$(".modal-area").eq(0).hide()},500)}}),$(function(){var a=$("body"),b=$(".full-screen"),c=$(".loading-area"),d={level:1,type:"bottom",model:"index",url:"index"},e=$.getRootPath(),f=[e+"/images/index-background.jpg",e+"/images/phrase-background.jpg",e+"/images/about-background.jpg",e+"/images/css-background.jpg"],g=function(c){a.removeClass().addClass(c),b.show(),setTimeout(function(){b.addClass("current")},100)},h=function(){b.removeClass("current"),setTimeout(function(){b.hide()},1370)};$(document).on("click",'[click-target="change-btn"]',function(){var a=$.extend({},{level:"1"},$(this).data());i(a)}).on("click",'[click-target="page-btn"]',function(){var a=$.extend({},{level:"2"},$(this).data());i(a)}).on("click",".modal-area",function(){$.closeModal()}).on("click",".modal-box",function(a){a.stopPropagation()});var i=function(a,b){a&&a.level&&a.model||(a=d);var c=$.setUrlWidthVars(a,e);return b?void history.replaceState(a,"",c):(history.pushState(a,"",c),void k(a))};window.addEventListener("popstate",function(a){a.state&&k(a.state)});var j=function(){},k=function(b){var c=a.data(),e=b;c&&c.level&&c.model||(c=d),e&&e.level&&e.model||(e=d);var f=c.level,g=e.level;if(f!=g||c.model!=e.model){var h="hide";c.type=e.type="bottom",f>g?(h="down",c.type="page"):g>f&&(h="up",e.type="page");var i=$.Event(h+"."+c.model,{l_state:c,n_state:e});console.debug(h+"."+c.model),a.trigger(i)}},l=function(b,c,d){var e=c.type,f=c.model,d=d+100;0==$("#"+e).length&&a.append("<div id="+e+"></div>"),$("#"+e).show().load(f+".html ."+f+"-area",function(b,g){if("error"==g)return void j();var i=$(this);"bottom"==e&&(d+=1500,h()),setTimeout(function(){i.find("."+f+"-area").addClass("current");var b=$.Event("done."+f);a.data(c).trigger(b)},d)})},m=function(c,d,e){var f=c.type,h=c.model,e=e;b.hasClass("current")||(g(d.model),e+=1500),a.find("."+h+"-area").removeClass("current"),setTimeout(function(){var b=$.Event("show."+d.model,{l_state:c,n_state:d});console.debug("show."+d.model),$("#"+f).hide(),a.trigger(b)},e)},n=function(b,c,d){{var f=b.model,d=d,g=c.model,h=c.type;c.url}$("."+f+"-area").addClass("page-current"),0==$("#"+h).length&&a.append("<div id="+h+' style="display:block;"></div>'),setTimeout(function(){$("#"+h).show().addClass("page-"+g).load($.setUrlWidthVars(c,e)+" ."+g+"-area",function(b,d){if("error"==d)return void j();var e=$(this);setTimeout(function(){e.find("."+g+"-area").addClass("current")},100);var f=$.Event("done."+g);a.data(c).trigger(f)})},d)},o=function(b,c,d){{var f=b.model,g=b.type,d=d,h=c.model,i=c.type;c.url}$("#"+g).find("."+f+"-area").removeClass("current").end().delay(1e3).hide(0),0==$("#"+i).length&&a.append("<div id="+i+' style="display:block;"></div>'),setTimeout(function(){$("#"+i).find(" ."+h+"-area").length>0?$("#"+i).find(" ."+h+"-area").removeClass("page-current"):$("#"+i).addClass(h).load($.setUrlWidthVars(c,e)+" ."+h+"-area",function(b,d){if("error"==d)return void j();var e=$(this);e.find("."+h+"-area").addClass("current");var f=$.Event("done."+h);a.data(c).trigger(f)}),a.data(c)},d)},p=function(a,b,c){var d=_.slice(_.filter(post_map,function(b){return b.catgory?b.catgory.match(a):!1}),b,b+c);return d},q={};q.essay=function(a,b,c){b&&c||(b=0,c=20),a||(a="essay");var d=p(a,b,c),e=[];if(0===d.length)return!1;for(var c=d.length,f=0;c>f;f++){var g=d[f],h=g.time.split("-");e.push('<div class="article-box"><hgroup><h3 class="article-title">'),e.push(g.title),e.push('</h3><aside><span class="article-time"><i class="year">'),e.push(h[0]),e.push('</i><i class="month">'),e.push(h[1]),e.push('</i><i class="day">'),e.push(h[2]),e.push('</i></span><span class="article-author">'),e.push(g.author),e.push('</span></aside></hgroup><div class="article-intro">'),e.push(g.intro),e.push('</div><div class="article-more" click-target="page-btn" data-model="essay-page"  data-url="'+g.dest+'">read more</div></div>')}var i={start:b,length:c,catgory:a};return 0===b?$(".essay-list").data(i).html(e.join("")):$(".essay-list").data(i).append(e.join("")),$(".essay-area.scroll-pane").jScrollPane({verticalGutter:-10}),!0},q.phrase=function(a,b,c){b&&c||(b=0,c=20),a||(a="prose");var d=p(a,b,c),e=[];if(0===d.length&&0!==b)return!1;for(var c=d.length,f=0;c>f;f++){var g=d[f],h=g.time.split("-"),i=g.dest.split("\\");i[i.length-1]="images\\"+i[i.length-1]+".jpg",i=i.join("\\"),e.push('<div class="article-box" click-target="page-btn" data-model="phrase-page"  data-url="'+g.dest+'" ><img src="'+i+'"><hgroup><h3 class="article-title">'),e.push(g.title),e.push('</h3><aside class="article-time">'),e.push(h[0]),e.push("年"),e.push(h[1]),e.push("月"),e.push(h[2]),e.push('日</aside><aside class="article-author">by '),e.push(g.author),e.push("</aside></hgroup></div>")}var j={start:b,length:c,catgory:a};return 0===b?$(".phrase-list").data(j).html(e.join("")):$(".phrase-list").data(j).append(e.join("")),$(".phrase-area.scroll-pane").jScrollPane({verticalGutter:-10}),!0},q.css=function(a,b,c){b&&c||(b=0,c=20),a||(a="css");var d=p(a,b,c),e=[];if(0===d.length&&0!==b)return!1;for(var c=d.length,f=0;c>f;f++){var g=d[f],h=g.time.split("-");e.push('<div class="article-box">'),e.push('<span class="article-time"><i class="day">'),e.push(h[2]),e.push('</i><i class="month">'),e.push(MONTHS[h[1]-1]),e.push('</i><i class="year">'),e.push(h[0]),e.push('</i></span><h3 class="article-title">'),e.push(g.title),e.push('</h3><span class="article-author">'),e.push(g.author),e.push('</span><div class="article-more"  click-target="page-btn" data-model="css-page"  data-url="'+g.dest+'" ><span></span></div></div>')}var i={start:b,length:c,catgory:a};return 0===b?$(".css-list").data(i).html(e.join("")):$(".css-list").data(i).append(e.join("")),$(".css-main-box.scroll-pane").jScrollPane({verticalGutter:-10}),!0},$(document).on("jsp-scroll-y",".essay-area,.phrase-area,.css-main-box",function(a,b,c,d){d&&$(this).find(".more-btn").click()}).on("click",".more-btn",function(){var a=$(this),b=a.data("model"),c=$("."+b+"-list"),d=c.data("start")?c.data("start"):0,e=a.data("length")?a.data("length"):20,f=c.data("catgory")?c.data("catgory"):b;a.html("查看更多").addClass("current");var g=q[b](f,d+e,e);a.removeClass("current"),g||a.html("没有更多了")}).on("click",'[click-target="catgory-btn"]',function(){var a=$(this),b=a.data("model"),c=a.data("catgory");a.siblings().removeClass("current").end().addClass("current"),q[b](c)}),a.on("show.index",function(a){var b=0;l(a.l_state,a.n_state,b)}).on("hide.index",function(a){var b=0;m(a.l_state,a.n_state,b)}).on("up.index",function(a){var b=0;n(a.l_state,a.n_state,b)}).on("down.index-page",function(a){var b=0;o(a.l_state,a.n_state,b)}).on("done.index-page",function(){REACT_COMMENT.theComment=React.render(React.createElement(LeaveWordComment,{}),$(".index-page-container")[0])}).on("show.essay",function(a){var b=0,c=a.n_state;c.type="top",l(a.l_state,c,b)}).on("hide.essay",function(a){var b=500,c=a.l_state;c.type="top",m(c,a.n_state,b)}).on("up.essay",function(a){var b=0;n(a.l_state,a.n_state,b)}).on("down.essay-page",function(a){var b=0,c=a.n_state;c.type="top",o(a.l_state,c,b)}).on("done.essay",function(){q.essay(),$(".essay-area").jScrollPane({verticalGutter:-10})}).on("done.essay-page",function(){var b=a.data("url");g("essay"),REACT_COMMENT.theComment=React.render(React.createElement(Comment,{source_id:b}),$(".essay-page-area .mainbody-comment")[0])}).on("show.css",function(a){var b=0;l(a.l_state,a.n_state,b)}).on("hide.css",function(a){var b=0;m(a.l_state,a.n_state,b)}).on("done.css",function(){q.css(),$(".css-main-box").jScrollPane({verticalGutter:-10})}).on("up.css",function(a){var b=0;n(a.l_state,a.n_state,b)}).on("down.css-page",function(a){var b=0,c=a.n_state;o(a.l_state,c,b)}).on("done.css-page",function(){var b=a.data("url");REACT_COMMENT.theComment=React.render(React.createElement(Comment,{source_id:b}),$(".css-page-area .mainbody-comment")[0])}).on("show.phrase",function(a){var b=0;l(a.l_state,a.n_state,b)}).on("hide.phrase",function(a){var b=0;m(a.l_state,a.n_state,b)}).on("done.phrase",function(){q.phrase(),$(".phrase-area").jScrollPane({verticalGutter:-10})}).on("up.phrase",function(a){var b=0;n(a.l_state,a.n_state,b)}).on("down.phrase-page",function(a){var b=0,c=a.n_state;o(a.l_state,c,b)}).on("done.phrase-page",function(){var b=a.data("url");REACT_COMMENT.theComment=React.render(React.createElement(Comment,{source_id:b}),$(".phrase-page-area .mainbody-comment")[0])}).on("show.about",function(a){var b=0;l(a.l_state,a.n_state,b)}).on("hide.about",function(a){var b=0;m(a.l_state,a.n_state,b)}).on("done.about",function(){$(".about-area").jScrollPane({verticalGutter:-10})});var r=a.data();$("."+r.model+"-area").addClass("current");var s=$.Event("done."+r.model);a.trigger(s),"top"==r.type&&g(r.model),$.loadImg(f,$.noop,function(){},$.noop),window.onload=function(){c.addClass("current"),setTimeout(function(){c.hide()},1e3)}});